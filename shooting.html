<!DOCTYPE html>
<html lang="en">

<head>
    <style>
        #tank1 {
            background: #8583de;
            width: 40px;
            height: 40px;
            position: absolute;
        }

        #tank2 {
            background: #A3C9de;
            width: 40px;
            height: 40px;
            position: absolute;
        }

        #background {
            background: #E00001;
            position: absolute;
            width: 460px;
            height: 460px;
            left: 0px;
            top: 0px;
            border-style: solid;
            border-color: black;
            border-width: 20px;
        }

        #bombTank1 {
            background: #ffffff;
            width: 10px;
            height: 10px;
            position: absolute;
        }

    </style>
    <meta charset="UTF-8">
    <title>BattleTank</title>
</head>

<body>
    <div id="background"></div>
    <div id="tank1"></div>
    <div id="tank2"></div>
    <div id="bombTank1"></div>
    <!--    <div id="tank"></div>-->
</body>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<script>
    var LEFT_KEY = 37;
    var UP_KEY = 38;
    var RIGHT_KEY = 39;
    var DOWN_KEY = 40;
    var SPACE_KEY = 32;
    var MOVEMENT = 20;

    var lastLoopRun = 0;

    var controller = new Object();

    var xPositionTank2 = "Waiting";
    var yPositionTank2 = "Waiting";
    var countLifeTank2;

    var typeShotTank1 = "0";
    var directionShotTank1 = "";

    var postValueTank2InX = "";
    var postValueTank2InY = "";
    var getValueTank2InX = "";
    var getValueTank2InY = "";

    var getValueLifeTank2 = "";

    function createObject(element, x, y, w, h) {
        var result = new Object();
        result.element = element;
        result.x = x;
        result.y = y;
        result.w = w;
        result.h = h;
        return result;
    }

    /*function toggleKey(keyCode, isPressed) {
        if (keyCode == LEFT_KEY) {
            controller.left = isPressed;
            handleControlsTank1();
        }
        if (keyCode == RIGHT_KEY) {
            controller.right = isPressed;
            handleControlsTank1();
        }
        if (keyCode == UP_KEY) {
            controller.up = isPressed;
            handleControlsTank1();
        }
        if (keyCode == DOWN_KEY) {
            controller.down = isPressed;
            handleControlsTank1();
        }
        if (keyCode == SPACE_KEY) {
            controller.space = isPressed;
            handleControlsTank1();
        }
        if (keyCode == "ric") {
            controller.up = isPressed;
        }
    }*/

    function ensureBorders(object) {
        if (object.x <= 20) {
            object.x = 20;
        }
        if (object.y <= 20) {
            object.y = 20;
        }
        if (object.x + object.w > 480) {
            object.x = 480 - object.w;
        }
        if (object.y + object.h > 480) {
            object.y = 480 - object.h;
        }
    }

    function setPosition(object) { //permitirá buscar posición del duende.
        var e = document.getElementById(object.element); //busca el elemento
        e.style.left = object.x + 'px'; //asigna las coordenadas donde estará el object
        e.style.top = object.y + 'px'; //asigna las coordenadas donde estará el object
    }

    function handleControlsTank1() {
        if (controller.up) {
            tank1.y -= MOVEMENT;
            console.log("X = " + tank1.x + " Y = " + tank1.y);
        }
        if (controller.down) {
            tank1.y += MOVEMENT;
            console.log("X = " + tank1.x + " Y = " + tank1.y);
        }
        if (controller.left) {
            tank1.x -= MOVEMENT;
            console.log("X = " + tank1.x + " Y = " + tank1.y);
        }
        if (controller.right) {
            tank1.x += MOVEMENT;
            console.log("X = " + tank1.x + " Y = " + tank1.y);
        }
        if (controller.space && bombTank1.y <= 50) {
            bombTank1.x = tank1.x + 20;
            bombTank1.y = tank1.y + bombTank1.h;
            console.log("bombTank1 X = " + bombTank1.x + " Y = " + bombTank1.y);
        }
        ensureBorders(tank1);
    }

    function showObjects() { //actualizar tank1
        setPosition(tank1);
        setPosition(bombTank1);
        setPosition(tank2);
    }
    //------------------------------------------------------------------------------------------------------//
    //POST Y GET DEL TANK2
    function postPositionTank2() {
        if (postValueTank2InX != tank2.x && postValueTank2InY != tank2.y) {
            $.ajax({
                type: "POST",
                url: "http://192.168.0.15:5000/api/v1/users/tank2",
                contentType: 'application/json;charset=UTF-8',
                data: JSON.stringify({
                    x: tank2.x,
                    y: tank2.y
                }, null, '\t'),
                dataType: "json",
                success: function(data) {
                    //console.log("Posición del tank 2 actualizada");
                }
            });
            postValueTank2InX = tank2.x;
            postValueTank2InY = tank2.y;
        } else {
            //console.log("No ha cambiado la posición el Tank2");
        }
    }

    function getPositionTank2() {
        //console.log("GET VALUE T2 X = " + getValueTank2InX + " X POSITION T2 = " + xPositionTank2);
        //        if (getValueTank2InX != xPositionTank2 && getValueTank2InY != yPositionTank2) {
        $.get("http://192.168.0.15:5000/api/v1/users/tank2", function(data, status) {
            xPositionTank2 = this;
            xPositionTank2 = data[data.length - 1].x;
            yPositionTank2 = this;
            yPositionTank2 = data[data.length - 1].y;
            //            console.log("GET X = " + xPositionTank2 + " Y = " + yPositionTank2);
        });
        //console.log(xPositionTank2);
        //console.log(yPositionTank2);

        /*            getValueTank2InX = xPositionTank2;
                    getValueTank2InY = yPositionTank2;

                    console.log("INSIDE GET VALUE T2 X = " + getValueTank2InX + " X POSITION T2 = " + getValueTank2InY);
                } else {
                    console.log("GET no ha cambiado la posición el Tank2");
                }*/
    }
    //------------------------------------------------------------------------------------------------------//
    //POST AND GET METODOS PARA ENVIAR LA VIDA ACTUALIZADA DEL TANK2 Y PARA RECIBIR CUANTO TIENE.
    function postLifeTank2(currentLifeTank) {
        console.log(currentLifeTank);
        $.ajax({
            type: "POST",
            url: "http://192.168.0.15:5000/api/v1/users/tank2/life",
            contentType: 'application/json;charset=UTF-8',
            data: JSON.stringify({
                total_life: currentLifeTank
            }, null, '\t'),
            dataType: "json",
            success: function(data) {
                console.log("Cantidad de vida del tank2 actualizada");
            }
        });
    }

    function getLifeTank2() {
        $.get("http://192.168.0.15:5000/api/v1/users/tank2/life", function(data, status) {
            countLifeTank2 = data;
            //console.log("LA VIDA DEL TANQUE ES = " + countLifeTank2);
        });
    }
    //------------------------------------------------------------------------------------------------------//


    function brainMovesTank1() {
        if (xPositionTank2 != "Waiting" && yPositionTank2 != "Waiting") {
            //console.log("x POSITION TANK " + xPositionTank2 + "Y POSITION TANK = " + yPositionTank2);
            if (tank1.x > xPositionTank2 && tank1.y != yPositionTank2) {
                tank1.x -= tank1.x - xPositionTank2;
                showObjects();
                decideShot("findY", tank1, bombTank1, tank2, yPositionTank2, countLifeTank2);
            } else if (tank1.x < xPositionTank2 && tank1.y != yPositionTank2) {
                tank1.x += xPositionTank2 - tank1.x;
                showObjects();
                decideShot("findY", tank1, bombTank1, tank2, yPositionTank2, countLifeTank2);
            } else if (tank1.y > yPositionTank2 && tank1.x != xPositionTank2) {
                tank1.y -= tank1.y - yPositionTank2;
                showObjects();
                decideShot("findX", tank1, bombTank1, tank2, xPositionTank2, countLifeTank2);
            } else if (tank1.y < yPositionTank2 && tank1.x != xPositionTank2) {
                tank1.y += yPositionTank2 - tank1.y;
                showObjects();
                decideShot("findX", tank1, bombTank1, tank2, xPositionTank2, countLifeTank2);
            }
        }
    }

    function decideShot(angle, element, bombTank1, destinyElement, positionTank, countLifeTank) {
        if (countLifeTank != 0) {
            //console.log("DECIDE SHOT TIENE COUNT LIFE TANK = " + countLifeTank);
            if (angle == "findY") {
                if (element.y < positionTank) {
                    shot(element, bombTank1, destinyElement, countLifeTank, "DOWN");
                } else if (element.y > positionTank) {
                    shot(element, bombTank1, destinyElement, countLifeTank, "UP");
                }
            } else if (angle == "findX") {
                if (element.x < positionTank) {
                    shoot(element, countLifeTank, "RIGHT");
                } else if (element.x > positionTank) {
                    shoot(element, bombTank1, destinyElement, countLifeTank, "LEFT");
                }
            }
        } else if (countLifeTank == 0) {
            alert("¡TERMINÓ EL JUEGO!\nGANÓ = " + element.element + " PERDIÓ = " + destinyElement.element + " VIDA = " + countLifeTank);
            countLifeTank = "";
        }
    }

    function shot(element, bombTank1, destinyElement, countTank, moveShot) {
        if (countTank == 100) {
            if (moveShot == "DOWN") {
                directionShotTank1 = "DOWN";
                initbombTank1();
                checkCollisionTank(element, bombTank1, destinyElement, countTank);
            } else if (moveShot == "UP") {
                directionShotTank1 = "UP";
                decideDirectionShot();
                initbombTank1();
                checkCollisionTank(element, bombTank1, destinyElement, countTank);
            }
        } else if (countTank == 50) {


        } else if (countTank < 50) {

        }
    }

    function initbombTank1() {
        if (bombTank1.y <= 20) {
            bombTank1.x = tank1.x + 20;
            bombTank1.y = tank1.y + bombTank1.h;
        } else if (bombTank1.y > 480) {
            bombTank1.x = tank1.x + 20;
            bombTank1.y = tank1.y + bombTank1.h;
        }
    }

    function checkCollisionTank(element, bombTank1, destinyElement, countTank) {
        if (intersects(bombTank1, destinyElement)) {
            console.log("DISPARO INTERSECTÓ A " + destinyElement.element);
            if (destinyElement.element == "tank2") {
                postLifeTank2(countTank);
            }
        } else {
            //console.log("No ha intersectado");
        }
    }

    function intersects(a, b) {
        return a.x < b.x + b.w && a.x + a.w > b.x && a.y < b.y + b.h && a.y + a.h > b.y;
    }

    function decideDirectionShot() { //
        if (countLifeTank2 != 0) {
            if (directionShotTank1 == "UP") {
                //console.log("ESTA EN SHOOTING IT UP\tGRACAS MI SEÑOR!");
                bombTank1.y -= 22;
                countLifeTank2 = 0;
            } else if (directionShotTank1 == "DOWN") {
                console.log("ESTA EN SHOOTING IT DOWN\tGRACAS MI SEÑOR!");
                bombTank1.y += 22;
                countLifeTank2 = 0;
            }
        }
    }



    function loop() {
        if (new Date().getTime() - lastLoopRun > 40) { //CONDICIÓN PARA HACER EL CICLO
            postPositionTank2(); //ENVIA LA POSICIÓN DEL TANK2 AL SERVER.
            getPositionTank2(); //RECIBE LA POSICIÓN DEL TANK2 AL SERVER.
            getLifeTank2();
            brainMovesTank1();
            ensureBorders(tank1);
            //handleControlsTank1();
            showObjects();
            decideDirectionShot();
            //initbombTank1();
            //countLifeTank2 = 0;
            lastLoopRun = new Date().getTime();
            //console.log("..");
            //console.log(countLifeTank2);
            moveTank2();
        }
        setTimeout('loop();', 100);
    }

    function moveTank2() {

        /*var random = Math.floor(Math.random() * 4);
        if (random == 0) {
            tank2.x += 15;
            ensureBorders(tank2);
        } else if (random == 1) {
            tank2.x -= 15;
            ensureBorders(tank2);
        } else if (random == 2) {
            tank2.y += 1;
            ensureBorders(tank2);
        } else if (random == 3) {
            tank2.y -= 1;
            ensureBorders(tank2);
        }*/
    }

    var tank1 = createObject('tank1', 250, 460, 40, 40);
    var tank2 = createObject('tank2', 290, 120, 40, 40);
    var bombTank1 = createObject('bombTank1', 0, -120, 5, 5);
    loop();

</script>

</html>
